<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Details</title>
  <style>
    /* Existing styles */
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button, a.button {
      margin-top: 20px;
      background: #0066cc;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    #commentsList {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    .comment {
      margin-bottom: 10px;
      background: #f2f2f2;
      padding: 8px;
      border-radius: 5px;
    }

    /* Dark mode styles */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #444;
    }
    body.dark-mode button,
    body.dark-mode a.button {
      background: #00509e;
      color: #fff;
    }
    body.dark-mode #commentsList {
      border-top: 1px solid #555;
    }
    body.dark-mode .comment {
      background: #333;
    }

    /* Theme toggle button */
    #themeToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      user-select: none;
    }
    body.dark-mode #themeToggle {
      background-color: #00509e;
    }
  </style>
</head>
<body>

<!-- Theme toggle button -->
<button id="themeToggle" aria-label="Toggle dark/light theme">Toggle Theme</button>

<h1>Student Details</h1>
<form id="studentForm">
  <label>Student Name</label>
  <input type="text" id="name" required />

  <label>Roblox Username</label>
  <input type="text" id="roblox" />

  <label>Discord Username</label>
  <input type="text" id="discord" />

  <label>Timeout Pass</label>
  <select id="timeout">
    <option value="Y">Y</option>
    <option value="N">N</option>
  </select>

  <label>Notes</label>
  <textarea id="notes"></textarea>

  <button type="submit">Save</button>
</form>

<h2>Comments / Notes</h2>
<div id="commentsList"></div>

<form id="addCommentForm">
  <label>Add Comment</label>
  <textarea id="newComment" required></textarea>
  <button type="submit">Add Comment</button>
</form>

<a href="index.html" class="button">Return</a>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
    authDomain: "pastoraldatabase.firebaseapp.com",
    projectId: "pastoraldatabase",
    storageBucket: "pastoraldatabase.firebasestorage.app",
    messagingSenderId: "859785843482",
    appId: "1:859785843482:web:4e0e5458391c1daee592a3",
    measurementId: "G-54LQVPWPJH"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Theme toggle logic
  const themeToggle = document.getElementById('themeToggle');

  function applyTheme(theme) {
    if (theme === 'dark') {
      document.body.classList.add('dark-mode');
    } else {
      document.body.classList.remove('dark-mode');
    }
  }

  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);

  themeToggle.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });

  // Student details logic

  const urlParams = new URLSearchParams(window.location.search);
  const studentId = urlParams.get('id');

  if (!studentId) {
    alert('No student selected.');
    window.location.href = 'student-list.html';
  }

  const nameInput = document.getElementById('name');
  const robloxInput = document.getElementById('roblox');
  const discordInput = document.getElementById('discord');
  const timeoutInput = document.getElementById('timeout');
  const notesInput = document.getElementById('notes');
  const commentsList = document.getElementById('commentsList');
  const newCommentInput = document.getElementById('newComment');

  let studentDocRef = db.collection('students').doc(studentId);
  let student = null;

  async function fetchStudent() {
    try {
      const doc = await studentDocRef.get();
      if (!doc.exists) {
        alert('Student not found.');
        window.location.href = 'student-list.html';
        return;
      }
      student = doc.data();
      loadStudentData();
    } catch (error) {
      alert('Error fetching student: ' + error.message);
      window.location.href = 'student-list.html';
    }
  }

  function renderComments() {
    commentsList.innerHTML = '';
    if (student.comments && student.comments.length) {
      student.comments.forEach(comment => {
        const div = document.createElement('div');
        div.classList.add('comment');
        div.textContent = comment;
        commentsList.appendChild(div);
      });
    } else {
      commentsList.textContent = 'No comments yet.';
    }
  }

  function loadStudentData() {
    nameInput.value = student.name || '';
    robloxInput.value = student.roblox || '';
    discordInput.value = student.discord || '';
    timeoutInput.value = student.timeout || 'N';
    notesInput.value = student.notes || '';
    renderComments();
  }

  document.getElementById('studentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    student.name = nameInput.value.trim();
    student.roblox = robloxInput.value.trim();
    student.discord = discordInput.value.trim();
    student.timeout = timeoutInput.value;
    student.notes = notesInput.value.trim();

    try {
      await studentDocRef.update(student);
      alert('Student details saved.');
    } catch (error) {
      alert('Failed to save student: ' + error.message);
    }
  });

  document.getElementById('addCommentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const newComment = newCommentInput.value.trim();
    if (!newComment) return;

    student.comments = student.comments || [];
    student.comments.push(newComment);

    try {
      await studentDocRef.update({ comments: student.comments });
      newCommentInput.value = '';
      renderComments();
    } catch (error) {
      alert('Failed to add comment: ' + error.message);
      student.comments.pop(); // revert in-memory
    }
  });

  fetchStudent();
</script>
</body>
</html>
