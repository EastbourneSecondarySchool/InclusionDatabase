<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .tab-btn {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid #444;
      border-bottom: none;
      background-color: #eee;
      margin-right: 5px;
    }
    .tab-btn.active {
      background-color: white;
      font-weight: bold;
    }
    .tab-content {
      border: 1px solid #444;
      padding: 15px;
      margin-top: -1px;
    }
    .hidden {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 300px;
      border-radius: 5px;
      position: relative;
    }
    .modal-buttons {
      margin-top: 15px;
      text-align: right;
    }
    .modal-buttons button {
      margin-left: 10px;
      padding: 6px 12px;
    }
    .notice {
      padding: 10px;
      margin-top: 10px;
      background-color: #ffeeba;
      border: 1px solid #f0ad4e;
    }
  </style>
</head>
<body>

<h1>Admin Panel</h1>

<button class="tab-btn active" data-tab="studentsTab">Students</button>
<button class="tab-btn" data-tab="staffTab">Staff</button>
<button class="tab-btn" data-tab="noticesTab">Password Notices</button>

<div id="studentsTab" class="tab-content">
  <h2>Students</h2>
  <table id="studentsTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Email</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="staffTab" class="tab-content hidden">
  <h2>Staff Members</h2>
  <button id="addStaffBtn">Add Staff Member</button>
  <table id="staffTable">
    <thead><tr><th>ID</th><th>Username</th><th>Role</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="noticesTab" class="tab-content hidden">
  <h2>Password Reset Requests</h2>
  <div id="noticesContainer"></div>
</div>

<!-- Modal for Adding Staff -->
<div id="editStaffModal" class="modal hidden">
  <div class="modal-content">
    <h3 id="staffModalTitle">Add Staff Member</h3>
    <label>Username:</label>
    <input type="text" id="staffUsername" />
    <label>Password:</label>
    <input type="password" id="staffPassword" />
    <label>Role:</label>
    <select id="staffRole">
      <option value="staff">Staff</option>
      <option value="admin">Admin</option>
    </select>
    <div class="modal-buttons">
      <button id="cancelStaffBtn">Cancel</button>
      <button id="saveStaffBtn">Save</button>
    </div>
  </div>
</div>

<!-- Firebase & Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
  authDomain: "pastoraldatabase.firebaseapp.com",
  projectId: "pastoraldatabase",
  storageBucket: "pastoraldatabase.firebasestorage.app",
  messagingSenderId: "859785843482",
  appId: "1:859785843482:web:4e0e5458391c1daee592a3",
  measurementId: "G-54LQVPWPJH"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tabs = document.querySelectorAll('.tab-btn');
const tabContents = {
  studentsTab: document.getElementById('studentsTab'),
  staffTab: document.getElementById('staffTab'),
  noticesTab: document.getElementById('noticesTab')
};
tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(tabContents).forEach(tab => tab.classList.add('hidden'));
    tabContents[btn.dataset.tab].classList.remove('hidden');
  });
});

function loadStudents() {
  const refPath = ref(db, 'students');
  onValue(refPath, snapshot => {
    const body = document.querySelector('#studentsTable tbody');
    body.innerHTML = '';
    const data = snapshot.val();
    if (data) {
      Object.values(data).forEach((student, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${student.name || ''}</td><td>${student.email || ''}</td>`;
        body.appendChild(tr);
      });
    }
  });
}

function loadStaff() {
  const refPath = ref(db, 'staff');
  onValue(refPath, snapshot => {
    const body = document.querySelector('#staffTable tbody');
    body.innerHTML = '';
    const data = snapshot.val();
    if (data) {
      Object.values(data).forEach((staff, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${staff.username}</td><td>${staff.role}</td>`;
        body.appendChild(tr);
      });
    }
  });
}

function loadNotices() {
  const container = document.getElementById('noticesContainer');
  const refPath = ref(db, 'passwordNotices');
  onValue(refPath, snapshot => {
    container.innerHTML = '';
    const data = snapshot.val();
    if (data) {
      Object.entries(data).forEach(([key, notice]) => {
        const div = document.createElement('div');
        div.className = 'notice';
        div.innerHTML = `
          <strong>Reset Request for:</strong> ${notice.username}<br />
          <button onclick="resetPassword('${key}', '${notice.username}')">Reset Password</button>
        `;
        container.appendChild(div);
      });
    } else {
      container.textContent = 'No password reset notices.';
    }
  });
}

window.resetPassword = async function (key, username) {
  const newPassword = prompt(`Enter new password for ${username}:`);
  if (!newPassword) return;

  const staffRef = ref(db, 'staff');
  onValue(staffRef, snapshot => {
    const data = snapshot.val();
    if (data) {
      Object.entries(data).forEach(([id, staff]) => {
        if (staff.username === username) {
          set(ref(db, `staff/${id}`), {
            ...staff,
            password: newPassword
          });
          remove(ref(db, `passwordNotices/${key}`));
          alert('Password reset.');
        }
      });
    }
  }, { onlyOnce: true });
}

// Staff modal
const addStaffBtn = document.getElementById('addStaffBtn');
const cancelStaffBtn = document.getElementById('cancelStaffBtn');
const saveStaffBtn = document.getElementById('saveStaffBtn');
const editStaffModal = document.getElementById('editStaffModal');
const staffUsernameInput = document.getElementById('staffUsername');
const staffPasswordInput = document.getElementById('staffPassword');
const staffRoleSelect = document.getElementById('staffRole');

addStaffBtn.addEventListener('click', () => {
  staffUsernameInput.value = '';
  staffPasswordInput.value = '';
  staffRoleSelect.value = 'staff';
  editStaffModal.classList.remove('hidden');
});

cancelStaffBtn.addEventListener('click', () => {
  editStaffModal.classList.add('hidden');
});

saveStaffBtn.addEventListener('click', async () => {
  const username = staffUsernameInput.value.trim();
  const password = staffPasswordInput.value.trim();
  const role = staffRoleSelect.value;
  if (!username || !password) return alert('Fill all fields.');
  const staffRef = ref(db, 'staff');
  const newStaffRef = push(staffRef);
  await set(newStaffRef, { username, password, role });
  editStaffModal.classList.add('hidden');
});

// Init
loadStudents();
loadStaff();
loadNotices();
</script>

</body>
</html>
