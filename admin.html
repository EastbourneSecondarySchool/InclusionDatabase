<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #444; border-bottom: none; background-color: #eee; margin-right: 5px; }
    .tab-btn.active { background-color: white; font-weight: bold; }
    .tab-content { border: 1px solid #444; padding: 15px; margin-top: -1px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: left; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 20px; width: 300px; border-radius: 5px; position: relative; }
    .modal-content h3 { margin-top: 0; }
    .modal-content label { display: block; margin-top: 10px; }
    .modal-content input, .modal-content select { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
    .modal-buttons { margin-top: 15px; text-align: right; }
    .modal-buttons button { margin-left: 10px; padding: 6px 12px; }
    #noticesList li { margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <button class="tab-btn active" data-tab="studentsTab">Students</button>
  <button class="tab-btn" data-tab="staffTab">Staff</button>
  <button class="tab-btn" data-tab="noticesTab">Password Notices</button>

  <div id="studentsTab" class="tab-content">
    <h2>Students</h2>
    <table id="studentsTable">
      <thead><tr><th>#</th><th>Name</th><th>Email</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="staffTab" class="tab-content hidden">
    <h2>Staff Members</h2>
    <button id="addStaffBtn">Add Staff Member</button>
    <table id="staffTable">
      <thead><tr><th>#</th><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="noticesTab" class="tab-content hidden">
    <h2>Forgot Password Notices</h2>
    <ul id="noticesList"></ul>
  </div>

  <!-- Staff Modal (Hidden by Default) -->
  <div id="editStaffModal" class="modal hidden">
    <div class="modal-content">
      <h3 id="staffModalTitle">Add Staff Member</h3>
      <label for="staffUsername">Username:</label>
      <input type="text" id="staffUsername" autocomplete="off" />
      <label for="staffPassword">Password: <small>(Leave blank to keep current password)</small></label>
      <input type="password" id="staffPassword" autocomplete="off" />
      <label for="staffRole">Role:</label>
      <select id="staffRole">
        <option value="staff">Staff</option>
        <option value="admin">Admin</option>
      </select>
      <div class="modal-buttons">
        <button id="deleteStaffBtn" style="float:left; background:#e74c3c; color:white; display:none;">Delete</button>
        <button id="cancelStaffBtn">Cancel</button>
        <button id="saveStaffBtn">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      onSnapshot,
      addDoc,
      doc,
      updateDoc,
      deleteDoc,
      query,
      where,
      getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
      authDomain: "pastoraldatabase.firebaseapp.com",
      projectId: "pastoraldatabase",
      storageBucket: "pastoraldatabase.appspot.com",
      messagingSenderId: "859785843482",
      appId: "1:859785843482:web:4e0e5458391c1daee592a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = {
      studentsTab: document.getElementById('studentsTab'),
      staffTab: document.getElementById('staffTab'),
      noticesTab: document.getElementById('noticesTab')
    };
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(tabContents).forEach(tab => tab.classList.add('hidden'));
        tabContents[btn.dataset.tab].classList.remove('hidden');
      });
    });

    const studentsTableBody = document.querySelector('#studentsTable tbody');
    const staffTableBody = document.querySelector('#staffTable tbody');
    const noticesList = document.getElementById('noticesList');

    const editStaffModal = document.getElementById('editStaffModal');
    const staffUsernameInput = document.getElementById('staffUsername');
    const staffPasswordInput = document.getElementById('staffPassword');
    const staffRoleSelect = document.getElementById('staffRole');
    const staffModalTitle = document.getElementById('staffModalTitle');
    const deleteStaffBtn = document.getElementById('deleteStaffBtn');

    let editingStaffId = null;

    const openModal = () => editStaffModal.classList.remove('hidden');
    const closeModal = () => editStaffModal.classList.add('hidden');

    function loadStudents() {
      const studentsCol = collection(db, 'students');
      onSnapshot(studentsCol, snapshot => {
        studentsTableBody.innerHTML = '';
        let idx = 1;
        snapshot.forEach(docSnap => {
          const student = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx++}</td><td>${student.name || ''}</td><td>${student.email || ''}</td>`;
          studentsTableBody.appendChild(tr);
        });
      });
    }

    function loadStaff() {
      const staffCol = collection(db, 'staffUsers');
      onSnapshot(staffCol, snapshot => {
        staffTableBody.innerHTML = '';
        let idx = 1;
        snapshot.forEach(docSnap => {
          const staff = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx++}</td>
            <td>${staff.username || ''}</td>
            <td>${staff.role || ''}</td>
            <td><button class="editBtn" data-id="${docSnap.id}">Edit</button></td>
          `;
          staffTableBody.appendChild(tr);
        });

        document.querySelectorAll('.editBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            editingStaffId = btn.dataset.id;
            const staffDoc = await getDoc(doc(db, 'staffUsers', editingStaffId));
            if (!staffDoc.exists()) {
              alert('Staff not found');
              return;
            }
            const staff = staffDoc.data();
            staffModalTitle.textContent = 'Edit Staff Member';
            staffUsernameInput.value = staff.username || '';
            staffPasswordInput.value = '';
            staffRoleSelect.value = staff.role || 'staff';
            deleteStaffBtn.style.display = 'inline-block';
            openModal();
          });
        });
      });
    }

    function loadNotices() {
      const noticesCol = collection(db, 'passwordNotices');
      onSnapshot(noticesCol, snapshot => {
        noticesList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const notice = docSnap.data();
          const li = document.createElement('li');
          li.innerHTML = `${notice.username} requested reset. <button>Reset</button>`;
          const resetBtn = li.querySelector('button');
          resetBtn.addEventListener('click', async () => {
            const newPassword = prompt(`Enter new password for ${notice.username}:`);
            if (newPassword) {
              const q = query(collection(db, 'staffUsers'), where('username', '==', notice.username));
              const match = await getDocs(q);
              for (const userDoc of match.docs) {
                await updateDoc(userDoc.ref, { password: newPassword });
              }
              await deleteDoc(doc(db, 'passwordNotices', docSnap.id));
              alert('Password reset.');
            }
          });
          noticesList.appendChild(li);
        });
      });
    }

    document.getElementById('addStaffBtn').addEventListener('click', () => {
      editingStaffId = null;
      staffModalTitle.textContent = 'Add Staff Member';
      staffUsernameInput.value = '';
      staffPasswordInput.value = '';
      staffRoleSelect.value = 'staff';
      deleteStaffBtn.style.display = 'none';
      openModal();
    });

    document.getElementById('cancelStaffBtn').addEventListener('click', closeModal);

    document.getElementById('saveStaffBtn').addEventListener('click', async () => {
      const username = staffUsernameInput.value.trim();
      const password = staffPasswordInput.value.trim();
      const role = staffRoleSelect.value;

      if (!username) return alert('Username required');

      try {
        const staffCol = collection(db, 'staffUsers');
        const q = query(staffCol, where('username', '==', username));
        const existing = await getDocs(q);

        if (!existing.empty && existing.docs.some(d => d.id !== editingStaffId)) {
          return alert('Username already exists.');
        }

        if (editingStaffId) {
          const updateData = { username, role };
          if (password) updateData.password = password;
          await updateDoc(doc(db, 'staffUsers', editingStaffId), updateData);
        } else {
          if (!password) return alert('Password required');
          await addDoc(staffCol, { username, password, role });
        }

        closeModal();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    deleteStaffBtn.addEventListener('click', async () => {
      if (!editingStaffId) return;
      if (!confirm('Delete this staff member?')) return;
      try {
        await deleteDoc(doc(db, 'staffUsers', editingStaffId));
        closeModal();
      } catch (err) {
        alert('Delete error: ' + err.message);
      }
    });

    // Initial load
    loadStudents();
    loadStaff();
    loadNotices();
  </script>
</body>
</html>
