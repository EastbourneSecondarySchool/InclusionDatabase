<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Behaviour Student Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
      authDomain: "pastoraldatabase.firebaseapp.com",
      projectId: "pastoraldatabase",
      storageBucket: "pastoraldatabase.firebasestorage.app",
      messagingSenderId: "859785843482",
      appId: "1:859785843482:web:4e0e5458391c1daee592a3",
      measurementId: "G-54LQVPWPJH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-8">
    <button onclick="window.location.href='behaviourdatabase.html'" class="mb-6 text-blue-600 hover:underline">‚Üê Return to Behaviour Database</button>
    <h1 id="studentName" class="text-3xl font-bold mb-6 text-center">Loading Student Details...</h1>

    <section>
      <h2 class="text-xl font-semibold mb-2">Behaviour Incidents</h2>
      <ul id="behaviourList" class="list-disc pl-6 mb-6 text-gray-700">
        <li>Loading...</li>
      </ul>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Isolations</h2>
      <ul id="isolationList" class="list-disc pl-6 mb-6 text-gray-700">
        <li>Loading...</li>
      </ul>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Exclusions</h2>
      <ul id="exclusionList" class="list-disc pl-6 mb-6 text-gray-700">
        <li>Loading...</li>
      </ul>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2 text-red-600">Debug Info</h2>
      <pre id="debugInfo" class="bg-gray-200 p-4 rounded overflow-x-auto max-h-64"></pre>
    </section>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const studentId = params.get('id');

    if (!studentId) {
      alert('No student ID provided.');
      window.location.href = 'behaviourdatabase.html';
    }

    const debugInfoEl = document.getElementById('debugInfo');

    async function loadStudentDetails() {
      try {
        const docRef = db.collection('students').doc(studentId);
        const doc = await docRef.get();

        if (!doc.exists) {
          document.getElementById('studentName').textContent = 'Student not found';
          ['behaviourList', 'isolationList', 'exclusionList'].forEach(id => {
            document.getElementById(id).innerHTML = '<li class="text-red-600">No data available.</li>';
          });
          debugInfoEl.textContent = 'Document does not exist.';
          return;
        }

        const data = doc.data();
        debugInfoEl.textContent = JSON.stringify(data, null, 2);

        document.getElementById('studentName').textContent = data.name || 'Unnamed Student';

        function formatDate(timestamp) {
          if (!timestamp) return '';
          if (timestamp.toDate) return timestamp.toDate().toLocaleString();
          return new Date(timestamp).toLocaleString();
        }

        function renderList(containerId, items, textKey = 'text', reasonKey = 'reason') {
          const container = document.getElementById(containerId);
          container.innerHTML = '';

          if (!Array.isArray(items) || items.length === 0) {
            container.innerHTML = '<li>No entries found.</li>';
            return;
          }

          items.forEach(item => {
            let description = item[textKey] || item[reasonKey] || 'No description';
            let timeStr = item.timestamp ? ` (on ${formatDate(item.timestamp)})` : '';
            const li = document.createElement('li');
            li.textContent = description + timeStr;
            container.appendChild(li);
          });
        }

        renderList('behaviourList', data.behaviourIncidents);
        renderList('isolationList', data.isolations);
        renderList('exclusionList', data.exclusions);

      } catch (error) {
        console.error('Error loading student details:', error);
        document.getElementById('studentName').textContent = 'Error loading student details';
        ['behaviourList', 'isolationList', 'exclusionList'].forEach(id => {
          document.getElementById(id).innerHTML = '<li class="text-red-600">Failed to load data.</li>';
        });
        debugInfoEl.textContent = error.message || 'Unknown error';
      }
    }

    loadStudentDetails();
  </script>
</body>
</html>
