<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Behaviour Student Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
      authDomain: "pastoraldatabase.firebaseapp.com",
      projectId: "pastoraldatabase",
      storageBucket: "pastoraldatabase.firebasestorage.app",
      messagingSenderId: "859785843482",
      appId: "1:859785843482:web:4e0e5458391c1daee592a3",
      measurementId: "G-54LQVPWPJH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function formatTimestamp(ts) {
      if (!ts) return 'Unknown date';
      if (ts.seconds !== undefined) {
        return new Date(ts.seconds * 1000).toLocaleString();
      }
      let date = new Date(ts);
      return isNaN(date.getTime()) ? 'Unknown date' : date.toLocaleString();
    }

    async function loadStudent() {
      const studentId = getQueryParam('id');
      if (!studentId) {
        alert('No student ID provided');
        return;
      }

      try {
        const doc = await db.collection('students').doc(studentId).get();
        if (!doc.exists) {
          alert('Student not found');
          return;
        }
        const data = doc.data();

        document.getElementById('studentName').textContent = data.name || 'No name';
        document.getElementById('studentYear').textContent = data.year || 'N/A';

        const behaviourList = document.getElementById('behaviourIncidents');
        const isolationList = document.getElementById('isolations');
        const exclusionList = document.getElementById('exclusions');

        behaviourList.innerHTML = '';
        isolationList.innerHTML = '';
        exclusionList.innerHTML = '';

        if (Array.isArray(data.behaviourIncidents) && data.behaviourIncidents.length) {
          data.behaviourIncidents.forEach(incident => {
            const li = document.createElement('li');
            li.textContent = `${incident.text} (on ${formatTimestamp(incident.timestamp)})`;
            behaviourList.appendChild(li);
          });
        } else {
          behaviourList.innerHTML = '<li>No behaviour incidents recorded.</li>';
        }

        if (Array.isArray(data.isolations) && data.isolations.length) {
          data.isolations.forEach(isolation => {
            const li = document.createElement('li');
            li.textContent = `${isolation.reason} (on ${formatTimestamp(isolation.timestamp)})`;
            isolationList.appendChild(li);
          });
        } else {
          isolationList.innerHTML = '<li>No isolations recorded.</li>';
        }

        if (Array.isArray(data.exclusions) && data.exclusions.length) {
          data.exclusions.forEach(exclusion => {
            const li = document.createElement('li');
            li.textContent = `${exclusion.reason} (on ${formatTimestamp(exclusion.timestamp)})`;
            exclusionList.appendChild(li);
          });
        } else {
          exclusionList.innerHTML = '<li>No exclusions recorded.</li>';
        }

      } catch (error) {
        console.error('Error loading student data:', error);
        alert('Failed to load student data.');
      }
    }

    window.onload = () => {
      loadStudent();
    };
  </script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-8">
    <button onclick="window.location.href='behaviourdatabase.html'" class="mb-6 text-blue-600 hover:underline">‚Üê Back to Behaviour Database</button>
    <h1 class="text-4xl font-bold mb-2" id="studentName">Loading...</h1>
    <p class="text-gray-600 mb-6">Year: <span id="studentYear">Loading...</span></p>

    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-3">Behaviour Incidents</h2>
      <ul id="behaviourIncidents" class="list-disc list-inside text-gray-800">
        <li>Loading behaviour incidents...</li>
      </ul>
    </div>

    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-3">Isolations</h2>
      <ul id="isolations" class="list-disc list-inside text-gray-800">
        <li>Loading isolations...</li>
      </ul>
    </div>

    <div>
      <h2 class="text-2xl font-semibold mb-3">Exclusions</h2>
      <ul id="exclusions" class="list-disc list-inside text-gray-800">
        <li>Loading exclusions...</li>
      </ul>
    </div>
  </div>
</body>
</html>
