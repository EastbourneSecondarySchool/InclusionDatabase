<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Behaviour Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-8">
    <button onclick="window.location.href='behaviourdatabase.html'" class="mb-6 text-blue-600 hover:underline">‚Üê Back to Behaviour Database</button>
    <h1 class="text-3xl font-bold mb-4" id="studentName">Loading...</h1>
    <p id="studentDetails" class="mb-6 text-gray-700"></p>

    <div id="behaviourContent">
      <section>
        <h2 class="text-xl font-semibold mt-6 mb-2">Behaviour Incidents</h2>
        <ul id="incidentList" class="space-y-2"></ul>
      </section>

      <section>
        <h2 class="text-xl font-semibold mt-6 mb-2">Isolations</h2>
        <ul id="isolationList" class="space-y-2"></ul>
      </section>

      <section>
        <h2 class="text-xl font-semibold mt-6 mb-2">Exclusions</h2>
        <ul id="exclusionList" class="space-y-2"></ul>
      </section>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
      authDomain: "pastoraldatabase.firebaseapp.com",
      projectId: "pastoraldatabase",
      storageBucket: "pastoraldatabase.firebasestorage.app",
      messagingSenderId: "859785843482",
      appId: "1:859785843482:web:4e0e5458391c1daee592a3",
      measurementId: "G-54LQVPWPJH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');

    const studentName = document.getElementById('studentName');
    const studentDetails = document.getElementById('studentDetails');
    const incidentList = document.getElementById('incidentList');
    const isolationList = document.getElementById('isolationList');
    const exclusionList = document.getElementById('exclusionList');

    function createEntryItem(entry, arrayName, index) {
      const li = document.createElement('li');
      li.className = "flex justify-between items-start bg-gray-50 p-3 rounded";

      const date = entry.timestamp?.toDate().toLocaleString() || 'Unknown';
      const text = entry.text || entry.reason || '';
      li.innerHTML = `
        <div>
          <p class="font-medium">${text}</p>
          <p class="text-sm text-gray-500">${date}</p>
        </div>
        <div class="flex gap-2">
          <button class="text-blue-600 hover:underline text-sm" onclick="editEntry('${arrayName}', ${index})">‚úèÔ∏è Edit</button>
          <button class="text-red-600 hover:underline text-sm" onclick="deleteEntry('${arrayName}', ${index})">üóë Delete</button>
        </div>
      `;
      return li;
    }

    async function loadStudentDetails() {
      try {
        const doc = await db.collection('students').doc(studentId).get();
        if (!doc.exists) {
          studentName.textContent = "Student not found";
          return;
        }

        const data = doc.data();
        studentName.textContent = data.name;
        studentDetails.textContent = `Year: ${data.year || 'N/A'} | Timeout Pass: ${data.timeoutPass || 'N/A'}`;

        window.currentStudentData = data; // Store for edit/delete access

        (data.behaviourIncidents || []).forEach((entry, i) => {
          incidentList.appendChild(createEntryItem(entry, 'behaviourIncidents', i));
        });

        (data.isolations || []).forEach((entry, i) => {
          isolationList.appendChild(createEntryItem(entry, 'isolations', i));
        });

        (data.exclusions || []).forEach((entry, i) => {
          exclusionList.appendChild(createEntryItem(entry, 'exclusions', i));
        });
      } catch (err) {
        console.error("Error loading student data:", err);
        studentName.textContent = "Failed to load student data.";
      }
    }

    async function editEntry(arrayName, index) {
      const studentRef = db.collection('students').doc(studentId);
      const data = window.currentStudentData;
      const currentEntry = data[arrayName][index];
      const currentText = currentEntry.text || currentEntry.reason;
      const newText = prompt("Edit entry:", currentText);
      if (newText && newText.trim() !== "") {
        const updatedArray = [...data[arrayName]];
        updatedArray[index] = {
          ...(currentEntry.text ? { text: newText } : { reason: newText }),
          timestamp: currentEntry.timestamp
        };
        await studentRef.update({ [arrayName]: updatedArray });
        location.reload();
      }
    }

    async function deleteEntry(arrayName, index) {
      if (!confirm("Are you sure you want to delete this entry?")) return;
      const studentRef = db.collection('students').doc(studentId);
      const data = window.currentStudentData;
      const updatedArray = [...data[arrayName]];
      updatedArray.splice(index, 1);
      await studentRef.update({ [arrayName]: updatedArray });
      location.reload();
    }

    loadStudentDetails();
  </script>
</body>
</html>
