<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Behaviour Student Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- Firebase SDK v9 modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuoUMX1iWfNYrX4FdFLlFjX-7yEumg0dc",
      authDomain: "pastoraldatabase.firebaseapp.com",
      projectId: "pastoraldatabase",
      storageBucket: "pastoraldatabase.firebasestorage.app",
      messagingSenderId: "859785843482",
      appId: "1:859785843482:web:4e0e5458391c1daee592a3",
      measurementId: "G-54LQVPWPJH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const studentId = params.get('id');

    const studentNameEl = document.getElementById('studentName');
    const behaviourList = document.getElementById('behaviourList');
    const isolationList = document.getElementById('isolationList');
    const exclusionList = document.getElementById('exclusionList');
    const debugOutput = document.getElementById('debugInfo');

    function formatDate(timestamp) {
      try {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
        return date.toLocaleDateString() + " " + date.toLocaleTimeString();
      } catch {
        return '';
      }
    }

    function populateList(listElement, items, label) {
      listElement.innerHTML = "";
      if (!Array.isArray(items) || items.length === 0) {
        listElement.innerHTML = `<li class="text-gray-500">No ${label} found.</li>`;
        return;
      }

      items.forEach((entry, i) => {
        const li = document.createElement('li');
        let reason = entry.reason || entry.text || "No reason provided";
        let time = entry.timestamp ? ` (${formatDate(entry.timestamp)})` : "";
        li.textContent = `${reason}${time}`;
        listElement.appendChild(li);
      });
    }

    async function fetchStudentData() {
      if (!studentId) {
        studentNameEl.textContent = "No student ID provided.";
        return;
      }

      try {
        const docRef = doc(db, "students", studentId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          studentNameEl.textContent = "Student not found.";
          debugOutput.textContent = "No document found for ID: " + studentId;
          return;
        }

        const data = docSnap.data();
        studentNameEl.textContent = data.name || "Unnamed Student";

        populateList(behaviourList, data.behaviourIncidents || [], "behaviour incidents");
        populateList(isolationList, data.isolations || [], "isolations");
        populateList(exclusionList, data.exclusions || [], "exclusions");

        debugOutput.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        studentNameEl.textContent = "Error loading student data.";
        debugOutput.textContent = "Error: " + error.message;
        console.error("Error fetching student:", error);
      }
    }

    fetchStudentData();
  </script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded p-6">
    <button onclick="window.location.href='behaviourdatabase.html'" class="text-blue-600 hover:underline mb-4">‚Üê Back to Behaviour Database</button>
    <h1 id="studentName" class="text-3xl font-bold mb-6 text-center">Loading student...</h1>

    <div>
      <h2 class="text-xl font-semibold mb-2">Behaviour Incidents</h2>
      <ul id="behaviourList" class="list-disc pl-6 text-gray-700 mb-6">
        <li>Loading...</li>
      </ul>
    </div>

    <div>
      <h2 class="text-xl font-semibold mb-2">Isolations</h2>
      <ul id="isolationList" class="list-disc pl-6 text-gray-700 mb-6">
        <li>Loading...</li>
      </ul>
    </div>

    <div>
      <h2 class="text-xl font-semibold mb-2">Exclusions</h2>
      <ul id="exclusionList" class="list-disc pl-6 text-gray-700 mb-6">
        <li>Loading...</li>
      </ul>
    </div>

    <div class="mt-8">
      <h2 class="text-red-600 font-semibold">Debug Info</h2>
      <pre id="debugInfo" class="bg-gray-200 p-4 rounded text-sm overflow-auto max-h-64"></pre>
    </div>
  </div>
</body>
</html>
